name: Test Install Scripts

on:
  push:
    branches: [main]
    paths:
      - 'install.sh'
      - 'install.ps1'
      - '.github/workflows/test-install.yml'
  pull_request:
    branches: [main]
    paths:
      - 'install.sh'
      - 'install.ps1'
      - '.github/workflows/test-install.yml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to test (e.g., 3.11.0)'
        required: false
        type: string

jobs:
  test-bash-install:
    name: Test Bash Install (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test install script syntax
        run: bash -n install.sh

      - name: Test --help flag
        run: bash install.sh --help

      - name: Test installation (latest)
        if: ${{ !github.event.inputs.version }}
        run: |
          bash install.sh
          # Verify installation
          export PATH="$HOME/.raps/bin:$PATH"
          raps --version
          raps --help

      - name: Test installation (specific version)
        if: ${{ github.event.inputs.version }}
        run: |
          RAPS_VERSION=${{ github.event.inputs.version }} bash install.sh
          # Verify installation
          export PATH="$HOME/.raps/bin:$PATH"
          raps --version
          raps --help

      - name: Test uninstall
        run: |
          bash install.sh --uninstall
          # Verify uninstall
          if [ -f "$HOME/.raps/bin/raps" ]; then
            echo "Error: Binary still exists after uninstall"
            exit 1
          fi

  test-powershell-install:
    name: Test PowerShell Install
    runs-on: windows-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test -Help flag
        shell: pwsh
        run: |
          .\install.ps1 -Help

      - name: Test installation (latest)
        if: ${{ !github.event.inputs.version }}
        shell: pwsh
        run: |
          .\install.ps1
          # Refresh PATH
          $env:Path = "$env:USERPROFILE\.raps\bin;$env:Path"
          # Verify installation
          raps --version
          raps --help

      - name: Test installation (specific version)
        if: ${{ github.event.inputs.version }}
        shell: pwsh
        run: |
          .\install.ps1 -Version "${{ github.event.inputs.version }}"
          # Refresh PATH
          $env:Path = "$env:USERPROFILE\.raps\bin;$env:Path"
          # Verify installation
          raps --version
          raps --help

      - name: Test uninstall
        shell: pwsh
        run: |
          .\install.ps1 -Uninstall
          # Verify uninstall
          if (Test-Path "$env:USERPROFILE\.raps\bin\raps.exe") {
            Write-Error "Binary still exists after uninstall"
            exit 1
          }

  test-pypi-install:
    name: Test PyPI Install (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.12']
    timeout-minutes: 15
    steps:
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Test pip install (latest)
        if: ${{ !github.event.inputs.version }}
        run: |
          pip install raps
          raps --version
          raps --help

      - name: Test pip install (specific version)
        if: ${{ github.event.inputs.version }}
        run: |
          pip install raps==${{ github.event.inputs.version }}
          raps --version
          raps --help
